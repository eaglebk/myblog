const RANKS=[{min:0,title:"Новичок"},{min:10,title:"Падаван"},{min:25,title:"Исследователь"},{min:50,title:"Мастер"},{min:100,title:"Архитектор"}];function fyShuffle(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function sampleQuestions(e,t,n=!0){const s=e.slice();n&&fyShuffle(s);const o=Math.max(0,Math.min(Number(t)||s.length,s.length));return s.slice(0,o||s.length)}function shuffleOptionsForQuestion(e){const t=e.options.map((e,t)=>t);for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}const n=t.map(t=>e.options[t]),s=t.indexOf(e.correctIndex);return{options:n,order:t,correctIndex:s}}let _lottieReady=null;function ensureLottiePlayer(){return _lottieReady||(_lottieReady=new Promise((e,t)=>{if(customElements.get("lottie-player"))return e();const n=document.createElement("script");n.type="module",n.src="https://unpkg.com/@lottiefiles/lottie-player@2.0.4/dist/lottie-player.js",n.onload=e,n.onerror=t,document.head.appendChild(n)}),_lottieReady)}function rankTitle(e){let t=RANKS[0].title;for(const n of RANKS)e>=n.min&&(t=n.title);return t}const mmss=e=>{e=Math.max(0,Math.min(359999,Math.floor(e||0)));const t=String(Math.floor(e/60)).padStart(1,"0"),n=String(e%60).padStart(2,"0");return`${t}:${n}`};function loadScript(e){return new Promise((t,n)=>{const s=document.createElement("script");s.src=e,s.onload=()=>t(),s.onerror=n,document.head.appendChild(s)})}async function applyHljsTheme(e,{cssHref:t=null,themeName:n="github-dark"}={}){const a="hljs-theme";let s=e.getElementById(a);s||(s=document.createElement("style"),s.id=a,e.appendChild(s));let o="";const r=_cleanStr(t||""),c=_cleanStr(n||"github-dark");async function i(e){const t=await fetch(e,{cache:"force-cache"});if(!t.ok)throw new Error(`hljs theme HTTP ${t.status} for ${e}`);return await t.text()}if(r)o=await i(r);else{const e="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles",t=`${e}/${c}.min.css`;try{o=await i(t)}catch{const t=`${e}/github-dark.min.css`;o=await i(t)}}o+=`
  .hljs{border-radius:14px;border:1px solid var(--border);padding:12px}
  `,s.textContent=o}function _cleanStr(e,t=""){return String(e??t).trim().replace(/^['"]+|['"]+$/g,"")}async function ensureHljs(e,{cssHref:t=null,themeName:n="github-dark"}={}){return window.hljs||(await loadScript("https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"),await loadScript("https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/rust.min.js")),await applyHljsTheme(e,{cssHref:t,themeName:n}),window.hljs}class QuizWidgetEl extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.state={view:"idle",quizIdx:0,qIdx:0,timeLeft:0,answers:[],startedAt:null,quizzes:[],user:null,stats:{rankXP:0,totalCompleted:0,totalCorrect:0},name:this.dataset.name||"Quiz"},this._timer=null,this._db=null,this._auth=null}connectedCallback(){this.renderShell()}playLottie(e,{loop:t=!1,durationMs:n=2200}={}){if(!e)return;const a=this.shadowRoot||this,s=a.querySelector(".container")||a;if(!s)return;getComputedStyle(s).position==="static"&&(s.style.position="relative"),s.classList.add("celebrate");const o=document.createElement("div");Object.assign(o.style,{position:"absolute",inset:"0",display:"grid",placeItems:"center",pointerEvents:"none",zIndex:"999",background:"radial-gradient(circle at center, rgba(10,12,20,.85) 0 130px, rgba(10,12,20,.55) 130px, rgba(10,12,20,0) 260px)",opacity:"0",transition:"opacity .12s ease"}),s.appendChild(o);const i=document.createElement("div");Object.assign(i.style,{background:"#0e1422",border:"1px solid var(--border)",borderRadius:"20px",padding:"8px 10px",boxShadow:"0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04)"}),o.appendChild(i),ensureLottiePlayer().then(()=>{const a=document.createElement("lottie-player");a.setAttribute("renderer","svg"),a.setAttribute("background","transparent"),a.setAttribute("src",e),a.setAttribute("autoplay",""),t&&a.setAttribute("loop",""),a.setAttribute("speed","1"),Object.assign(a.style,{width:"220px",height:"220px",display:"block"});const r=()=>{o.style.opacity="1"};a.addEventListener("load",r,{once:!0}),a.addEventListener("ready",r,{once:!0});const l=setTimeout(r,100),c=()=>{o.style.opacity="0",setTimeout(()=>{o.remove(),s.classList.remove("celebrate")},150)};if(!t){const e=setTimeout(c,n);a.addEventListener("complete",()=>{clearTimeout(e),c()},{once:!0})}i.appendChild(a)}).catch(()=>{o.remove(),s.classList.remove("celebrate")})}async init({srcArr:e,firebaseConfig:t,opts:n}){const i=[];this._lottiePerfect=n?.lottiePerfect||null,ensureLottiePlayer().catch(()=>{});const s=n?.passThreshold;let r=70;const a=s==null?null:Number(String(s).replace(/[^\d]/g,""));this._passThreshold=a,this._questionsLimit=n?.questionsLimit===null||n?.questionsLimit===void 0?null:Number(String(n?.questionsLimit).replace(/[^\d]/g,"")),this._shuffleQuestions=String(n?.shuffleQuestions??"true").replace(/['"]/g,"").trim().toLowerCase()==="true",this._hljsCssHref=n?.hljsCssHref||null,this._hljsThemeDark=n?.hljsThemeDark||"github-dark",this._hljsThemeLight=n?.hljsThemeLight||"github";for(const n of e||[]){const t=await fetch(n,{cache:"no-store"});if(!t.ok)throw new Error(`HTTP ${t.status} for ${n}`);i.push(await t.json())}this.state.quizzes=i;const o=firebase;if(o){if(this._auth=o.auth(),this._db=db,await this._auth.signInAnonymously().catch(()=>{}),this.state.user=this._auth.currentUser?{uid:this._auth.currentUser.uid,displayName:this._auth.currentUser.displayName||null,photoURL:this._auth.currentUser.photoURL||null}:null,this.state.user){const e=this._db.collection("users").doc(this.state.user.uid),t=await e.get();if(t.exists){const e=t.data()||{};this.state.stats.rankXP=e.rankXP||0,this.state.stats.totalCompleted=e.totalCompleted||0,this.state.stats.totalCorrect=e.totalCorrect||0}else await e.set({displayName:this.state.user.displayName,photoURL:this.state.user.photoURL,rankXP:0,totalCompleted:0,totalCorrect:0,createdAt:o.firestore.FieldValue.serverTimestamp()})}}else{const e=localStorage.getItem("quiz_user_cache");if(e)try{this.state.stats=JSON.parse(e)}catch{}else localStorage.setItem("quiz_user_cache",JSON.stringify(this.state.stats))}this.render()}computeResults(){const s=this.currentQuestions(),e=s.length,t=(this.state.answers||[]).filter(e=>e&&e.correct).length,n=e?Math.round(t/e*100):0,o=n>=(this._passThreshold??70);return{total:e,correct:t,percent:n,passed:o}}finish(){const e=this.currentQuiz();if(!e)return;const{total:t,correct:n,percent:s,passed:o}=this.computeResults();this.state.view="finished",this.state.finishedAt=Date.now(),this.state.passed=o,this.state.percent=s,n===t&&this._lottiePerfect&&this.playLottie(this._lottiePerfect,{durationMs:2500}),this.render()}ensureSelection(){const e=this.currentQuiz();if(!e)return!1;if(this.state.selectedQuestions&&this.state.shuf&&this.state.plannedTimeLimitSec)return!0;const t=sampleQuestions(e.questions,this._questionsLimit,this._shuffleQuestions),n=t.map(shuffleOptionsForQuestion),s=e.timeLimitSec||t.length*30;return this.state.selectedQuestions=t,this.state.shuf=n,this.state.plannedTimeLimitSec=s,!0}startQuiz(){const e=this.ensureSelection();if(!e)return;this.state.timeLeft=this.state.plannedTimeLimitSec,this.state.startedAt=Date.now(),this.state.answers=[],this.state.qIdx=0,this.state.view="running",this.tickStart(),this.render()}tickStart(){this._timer&&clearInterval(this._timer),this._timer=setInterval(()=>{this.state.timeLeft-=1,this.state.timeLeft<=0&&(this.state.timeLeft=0,this.finishQuiz("timeout")),this.updateTimerOnly()},1e3)}tickStop(){this._timer&&clearInterval(this._timer),this._timer=null}answer(e){const u=this.currentQuiz();if(!u)return;const m=this.currentQuestions(),o=m[this.state.qIdx],t=this.state.shuf&&this.state.shuf[this.state.qIdx]||shuffleOptionsForQuestion(o);if(this.state.answers[this.state.qIdx])return;const r=this.state.startedAt?Math.floor((Date.now()-this.state.startedAt)/1e3):0,i=e===t.correctIndex,c=t.order[e],l=o.correctIndex;this.state.answers[this.state.qIdx]={qid:o.id,pick:e,pickOriginal:c,correct:i,correctIndex:t.correctIndex,correctOriginal:l,elapsedSec:r};const d=this.shadowRoot||this,s=d.querySelector(".body"),a=s?.querySelector(".opts");if(!a)return;const h=a.querySelectorAll(".opt");h.forEach((n,s)=>{n.disabled=!0,n.style.cursor="default",n.setAttribute("aria-checked",s===e?"true":"false"),n.classList.remove("picked"),s===t.correctIndex&&n.classList.add("correct"),s===e&&s!==t.correctIndex&&n.classList.add("wrong")});let n=s.querySelector(".feedback");if(!n){if(n=document.createElement("div"),n.className=`feedback ${i?"ok":"err"}`,n.textContent=i?"Верно!":"Неверно.",!i){const e=document.createElement("div");e.className="stat",e.style.marginTop="4px";const s=document.createElement("strong");if(s.textContent=`${String.fromCharCode(65+t.correctIndex)})`,e.append("Правильный ответ: ",s),o.explanation){const t=document.createElement("div");t.style.marginTop="4px",t.textContent=o.explanation,e.appendChild(t)}n.appendChild(e)}s.appendChild(n)}if(!s.querySelector("[data-next]")){const t=document.createElement("div");t.style.marginTop="10px";const e=document.createElement("button");e.className="btn",e.setAttribute("data-next","1"),e.textContent="Далее",e.addEventListener("click",()=>this.next()),t.appendChild(e),s.appendChild(t)}}next(){const t=this.currentQuiz();if(!t)return;const e=this.state.qIdx+1;e>=this.state.selectedQuestions.length?this.finishQuiz("completed"):(this.state.qIdx=e,this.render())}async finishQuiz(e="completed"){if(this.state.view==="finished")return;this.tickStop();const s=this.currentQuiz();if(!s)return;const{total:a,correct:o,percent:c,passed:n}=this.computeResults();this.state.view="finished",this.state.finishedAt=Date.now(),this.state.finishedReason=e,this.state.passed=n,this.state.percent=c,a>0&&o===a&&this._lottiePerfect&&this.playLottie(this._lottiePerfect,{durationMs:2500});const t=this.state.answers.filter(e=>e.correct).length,r=this.state.answers.length-t,l=this.state.startedAt?Math.floor((Date.now()-this.state.startedAt)/1e3):0,i=n?o*2+3:Math.max(1,o);try{if(this._db&&this.state.user){const e=window.firebase,o=this._db.collection("users").doc(this.state.user.uid);await this._db.collection("users").doc(this.state.user.uid).collection("sessions").add({quizId:s.id,correctCount:t,passed:n,wrongCount:r,total:this.state.answers.length,elapsedSec:l,createdAt:e.firestore.FieldValue.serverTimestamp(),answers:this.state.answers});const a=this._db.collection("quizzes").doc(s.id).collection("stats").doc("stats");await a.set({runs:e.firestore.FieldValue.increment(1),correctTotal:e.firestore.FieldValue.increment(t),wrongTotal:e.firestore.FieldValue.increment(r)},{merge:!0}),await o.set({rankXP:e.firestore.FieldValue.increment(i),totalCompleted:e.firestore.FieldValue.increment(1),totalCorrect:e.firestore.FieldValue.increment(t)},{merge:!0}),this.state.stats.rankXP+=i,this.state.stats.totalCompleted+=1,this.state.stats.totalCorrect+=t,n&&(this.state.stats.passed+=1)}else this.state.stats.rankXP+=i,this.state.stats.totalCompleted+=1,this.state.stats.totalCorrect+=t,n&&(this.state.stats.passed+=1),localStorage.setItem("quiz_user_cache",JSON.stringify(this.state.stats))}catch(e){console.error(e)}this.render()}proceedNextQuiz(){const e=this.state.quizIdx+1;e<this.state.quizzes.length?(this.state.quizIdx=e,this.state.view="idle",this.state.answers=[],this.state.qIdx=0,this.state.timeLeft=0,this.state.startedAt=null,this.state.selectedQuestions=null,this.state.shuf=null,this.state.plannedTimeLimitSec=null):this.state.view="report",this.render()}restart(){this.state.view="idle",this.state.answers=[],this.state.qIdx=0,this.state.timeLeft=0,this.state.startedAt=null,this.state.selectedQuestions=null,this.state.shuf=null,this.state.plannedTimeLimitSec=null,this.render()}currentQuestions(){const e=this.currentQuiz();return this.state.selectedQuestions||(e?e.questions:[])}currentQuiz(){return this.state.quizzes[this.state.quizIdx]||null}renderShell(){const e=`
/* Цветовые токены — чуть теплее и контрастнее */
:host{
  --bg:#0c0f14; --card:#13151b; --muted:#9aa0b2; --border:#2b3040;
  --acc:#7c83ff; --acc-2:#4f46e5; --ok:#22c55e; --bad:#f87171; --warn:#f59e0b;
  --surface:#0f1218; --elev:#0e1117;
}

/* Карточка виджета: мягкая «высота», аккуратный бордер */
.container{
  border:1px solid var(--border);
  background: linear-gradient(180deg, var(--card), var(--elev));
  color:#e9edf4;
  border-radius:16px;
  padding:18px;
  max-width:820px;
  box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
}

/* Верхняя полоса: выравнивание и ритм */
.top{display:flex;align-items:center;justify-content:space-between;gap:16px}
.stat{font-size:12px;color:var(--muted);letter-spacing:.2px}
.stat strong{display:block;color:#fff;font-size:20px;font-weight:700}

/* Разделитель — чуть «воздушнее» */
.hr{height:1px;background:linear-gradient(90deg, transparent, var(--border), transparent);margin:14px 0}

/* Кнопки: более «кликабельные», фокус и disabled */
.btn{
  border:1px solid var(--border); background:#1a1f2a; color:#e6e9f2;
  padding:10px 14px; border-radius:12px; cursor:pointer; transition:transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
}
.btn:hover{transform:translateY(-1px); background:#212839}
.btn:active{transform:translateY(0)}
.btn:focus-visible{outline:none; box-shadow:0 0 0 3px rgba(124,131,255,.25)}
.btn[disabled]{opacity:.55; cursor:not-allowed}

/* Primary */
.btn.primary{background:linear-gradient(180deg, var(--acc), var(--acc-2)); border-color:transparent; color:#fff}
.btn.primary:hover{filter:brightness(1.05)}

/* Бейдж и таймер */
.badge{
  display:inline-flex;align-items:center;gap:8px;padding:4px 10px;
  border:1px solid var(--border);border-radius:999px;background:#131826;color:#dfe4f2;font-size:12px
}
.timer{
  font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
  border:1px solid var(--border);border-radius:10px;padding:3px 10px;background:#0f1420
}

/* Заголовки/код */
h2{margin:6px 0 10px;font-size:22px;line-height:1.35}
.code{
  white-space:pre-wrap;background:#0b0f18;border:1px solid var(--border);
  padding:12px;border-radius:14px;margin:10px 0;
  font-family:ui-monospace,Consolas,Menlo,monospace;font-size:13.5px;overflow:auto;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.03)
}

/* Варианты: крупнее кликабельная область и улучшенный контраст */
.opts{display:grid;gap:10px}
.opt{
  display:flex; align-items:center; gap:10px;
  padding:12px 14px; border:1px solid var(--border); border-radius:14px;
  text-align:left; cursor:pointer;
  background:#121722;
  transition:transform .08s ease, border-color .15s ease, background .15s ease, box-shadow .15s ease;
}
.opt:hover{transform:translateY(-1px); background:#151b29}
.opt:focus-visible{outline:none; box-shadow:0 0 0 3px rgba(124,131,255,.25)}
.opt .letter{
  width:28px;height:28px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;
  background:#0f1522;border:1px solid var(--border);color:#c8d0e3;font-weight:600;flex:0 0 28px
}
.opt .text{flex:1;color:#dbe2f5}

/* Состояния ответа */
.opt.picked{border-color:#8ea2ff; background:#263071}
.opt.correct{border-color:#22c55e; background:#0c3b2b}
.opt.wrong{border-color:#f87171; background:#4c1f1f}

/* Подсказка после ответа */
.feedback{font-size:15px;margin-top:10px}
.feedback.ok{color:#22c55e}
.feedback.err{color:#f87171}

/* Прогресс/итог */
.progress{
  height:10px;border:1px solid var(--border);border-radius:999px;overflow:hidden;background:#0f131d
}
.progress>div{height:100%;background:linear-gradient(90deg, #22c55e, #16a34a);transition:width .25s}
.cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:14px 0}
.card{
  border:1px solid var(--border);border-radius:14px;background:#121722;padding:14px;text-align:center;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.03)
}

/* «Пирог» остаётся, но делаем аккуратнее */
.pie{width:160px;height:160px;border-radius:50%;
  background:conic-gradient(#22c55e calc(var(--p)*1%), #394356 0)}
.pie-wrap{display:flex;align-items:center;justify-content:center;height:180px}

/* Анимации + respect reduced motion */
.fade{animation:fade .16s ease}
@keyframes fade{from{opacity:.001;transform:translateY(2px) scale(.995)}to{opacity:1;transform:translateY(0) scale(1)}}
@media (prefers-reduced-motion: reduce){
  .fade, .opt, .btn{animation:none; transition:none}
}

/* Отчёт — сетка и карточки */
.qgrid{display:grid;gap:12px}
.qcard{
  border:1px solid var(--border); border-radius:14px; background:#121722; padding:12px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.03)
}
.qcard.ok{border-color:rgba(34,197,94,.35)}
.qcard.err{border-color:rgba(248,113,113,.35)}

.qhdr{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:8px}
.qtitle .qt{font-weight:700;font-size:18px;line-height:1.35;color:#e9edf4}
.qstatus{font-weight:700}
.qcard.ok .qstatus{color:var(--ok)}
.qcard.err .qstatus{color:var(--bad)}

.qcode{margin-top:8px}

.qa{margin-top:10px}
.you{font-size:16px;font-weight:800;margin-top:2px;color:#e8ecf7}
.you.ok{color:#22c55e}
.you.err{color:#f87171}

.correct-ans{font-size:16px;font-weight:700;color:#dfe5f7;margin-top:2px}
.hint{margin-top:8px;color:var(--muted);font-size:13.5px}

.filterbar .btn.active{
  background:#212839; border-color:#3a4154;
}
.btn.btn-ghost{
  background:transparent; border-color:#2a2f3e; color:#cfd6ea;
}
.btn.btn-ghost:hover{background:#1a1f2a}

/* режим празднования: приглушаем круговую диаграмму */
.celebrate .pie-wrap { opacity:.25; filter:blur(1px); transition:opacity .2s, filter .2s }
.celebrate .cards   { opacity:.6; transition:opacity .2s }

/* необязательно, но красиво подсветит оверлей */
.lottie-overlay-fade { opacity:0; transition:opacity .12s ease }
.lottie-overlay-fade.show { opacity:1 }

`;this.shadowRoot.innerHTML=`
      <style>${e}</style>
      <div class="container">
        <div class="top">
          <div><div class="stat">Текущий ранг</div><div class="rank"><strong>-</strong></div></div>
          <div><div class="stat">Выполнено</div><div class="done"><strong>0</strong> <span>тестов</span></div></div>
          <div class="auth"></div>
        </div>
        <div class="hr"></div>
        <div class="body"></div>
      </div>
    `}updateTimerOnly(){const e=this.shadowRoot.querySelector(".timer");e&&(e.textContent=`⌚️ ${mmss(this.state.timeLeft)}`)}render(){this.shadowRoot.querySelector(".rank strong").textContent=rankTitle(this.state.stats.rankXP);const n=this.state.stats.totalCompleted,s=n===0?"тестов":n===1?"тест":n<5?"теста":"тестов";this.shadowRoot.querySelector(".done strong").textContent=`${n}`,this.shadowRoot.querySelector(".done span").textContent=`${s}`;const e=this.shadowRoot.querySelector(".body");e.innerHTML="";const t=this.currentQuiz();if(this.state.view==="idle"&&t){this.ensureSelection();const n=this.state.selectedQuestions||t.questions,s=this.state.plannedTimeLimitSec||n.length*30;e.innerHTML=`
  <div class="fade">
    <div class="stat"
         style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:12px">
      <span class="badge">Тест ${this.state.quizIdx+1}/${this.state.quizzes.length}</span>
      <span class="badge">Вопросов: ${n.length}</span>
      <span class="badge">⏱ ${mmss(s)}</span>
      <span class="badge">Порог: ${this._passThreshold}%</span>
    </div>
    <h2 style="margin-top:12px">${t.topic}</h2>
    ${t.description?`<div class="stat" style="margin-bottom:12px">${t.description}</div>`:""}
    <div style="margin-top:12px">
      <button class="btn primary">Пройти тест</button>
    </div>
  </div>
`,e.querySelector(".btn.primary").onclick=()=>this.startQuiz();return}if(this.state.view==="running"&&t){const c=this.currentQuestions(),t=c[this.state.qIdx],a=this.state.shuf[this.state.qIdx],l=this.state.answers,o=l[this.state.qIdx]??null,r=!!o,i=a.correctIndex,n=document.createElement("div");if(n.className="fade",n.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div class="badge"><span>?</span> <span>Вопрос ${this.state.qIdx+1}/${this.state.selectedQuestions.length}</span></div>
      <div class="timer">${mmss(this.state.timeLeft)}</div>
    </div>
    <div class="qtitle" style="font-weight:600;font-size:18px;margin:6px 0"></div>
  `,e.appendChild(n),n.querySelector(".qtitle").textContent=t.title,t.code){const s=document.createElement("pre");s.className="code hljs";const n=document.createElement("code");n.className="language-rust",n.textContent=t.code,s.appendChild(n),e.appendChild(s);const o=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,i=this._hljsCssHref?null:o?this._hljsThemeDark||"github-dark":this._hljsThemeLight||"github";ensureHljs(this.shadowRoot,{cssHref:this._hljsCssHref,themeName:i}).then(e=>{try{e.highlightElement(n)}catch{}})}const s=document.createElement("div");if(s.className="opts",a.options.forEach((e,t)=>{const n=document.createElement("button");n.type="button",n.className="opt",n.setAttribute("role","radio"),n.tabIndex=0;const a=document.createElement("span");a.className="letter",a.textContent=String.fromCharCode(65+t);const c=document.createElement("span");if(c.className="text",c.textContent=e,n.append(a,c),r){const e=o.pick===t;n.setAttribute("aria-checked",e?"true":"false"),t===i&&n.classList.add("correct"),e&&t!==i&&n.classList.add("wrong"),n.disabled=!0,n.style.cursor="default",n.addEventListener("keydown",e=>{(e.key==="Enter"||e.key===" ")&&e.preventDefault()})}else{const e=()=>{n.classList.add("picked"),s.querySelectorAll(".opt").forEach(e=>e.disabled=!0),this.answer(t)};n.setAttribute("aria-checked","false"),n.addEventListener("click",e),n.addEventListener("keydown",t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),e())})}s.appendChild(n)}),e.appendChild(s),r){const r=!!o.correct,n=document.createElement("div");if(n.className=`feedback ${r?"ok":"err"}`,r)n.textContent="Верно!";else{const s=document.createElement("div");s.appendChild(document.createTextNode("Неверно."));const e=document.createElement("div");e.className="stat",e.style.marginTop="4px";const o=document.createElement("strong");if(o.textContent=`${String.fromCharCode(65+i)})`,e.appendChild(document.createTextNode("Правильный ответ: ")),e.appendChild(o),t.explanation){const n=document.createElement("div");n.style.marginTop="4px",n.textContent=t.explanation,e.appendChild(n)}s.appendChild(e),n.appendChild(s)}e.appendChild(n);const a=document.createElement("div");a.style.marginTop="10px";const s=document.createElement("button");s.className="btn",s.textContent="Далее",s.addEventListener("click",()=>this.next()),a.appendChild(s),e.appendChild(a)}return}if(this.state.view==="finished"&&t){const{total:o,correct:t,percent:i,passed:a}=this.computeResults(),r=o-t;e.innerHTML=`
        <div class="fade">
          <h2>${a?"Тест пройден":"Тест не пройден"}</h2>
          <div class="pie-wrap">
            <div class="pie" style="--p:${i}"></div>
          </div>
          <div class="cards">
            <div class="card"><div class="stat">Верных</div><div style="font-size:24px">${t}</div></div>
            <div class="card"><div class="stat">Неверных</div><div style="font-size:24px">${r}</div></div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn primary" data-report>Перейти к отчёту</button>
            ${this.state.quizIdx+1<this.state.quizzes.length?`<button class="btn" data-next>Следующий тест</button>`:`<button class="btn" data-restart>Назад</button>`}
          </div>
        </div>
      `,e.querySelector("[data-report]").onclick=()=>{this.state.view="report",this.render()};const n=e.querySelector("[data-next]"),s=e.querySelector("[data-restart]");n&&(n.onclick=()=>this.proceedNextQuiz()),s&&(s.onclick=()=>this.restart());return}if(this.state.view==="report"&&t){const i=this.state.answers,c=this.currentQuestions(),s=c.length,o=this.state.answers.filter(e=>e?.correct).length,l=s-o,a=s?Math.round(o/s*100):0,d=i.length?Math.max(...i.map(e=>e?.elapsedSec||0)):0;this._reportFilter=this._reportFilter||"all";const t=document.createElement("div");t.className="fade",t.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h2 style="margin:0">Отчёт</h2>
      <button class="btn" data-close>Завершить</button>
    </div>

    <div class="stat" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <span>Успех: <strong>${a}%</strong></span>
      <span>Время: <strong>${mmss(d)}</strong></span>
      <span>Верных: <strong>${o}</strong></span>
      <span>Неверных: <strong>${l}</strong></span>
    </div>

    <div class="progress" style="margin:8px 0 10px">
      <div style="width:${a}%"></div>
    </div>

    <div class="filterbar" style="display:flex;gap:8px;align-items:center;margin:10px 0 4px">
      <button class="btn ${this._reportFilter==="all"?"active":""}" data-filter="all">Все вопросы</button>
      <button class="btn ${this._reportFilter==="errors"?"active":""}" data-filter="errors">Только ошибки</button>
      <div style="flex:1"></div>
      <button class="btn" data-restart style="display:none">Назад</button>
    </div>

    <div class="hr"></div>
  `,e.appendChild(t),t.querySelector("[data-close]").addEventListener("click",()=>{this.state.view="idle",this.render()}),t.querySelector("[data-restart]").addEventListener("click",()=>this.restart()),t.querySelectorAll("[data-filter]").forEach(e=>{e.addEventListener("click",e=>{const n=e.currentTarget.getAttribute("data-filter");this._reportFilter=n,t.querySelectorAll("[data-filter]").forEach(e=>e.classList.remove("active")),e.currentTarget.classList.add("active"),r()})});const n=document.createElement("div");n.className="qgrid",e.appendChild(n);const r=()=>{if(n.innerHTML="",this.state.selectedQuestions.forEach((e,t)=>{const o=this.state.answers[t]||null,a=this.state.shuf&&this.state.shuf[t]||shuffleOptionsForQuestion(e),r=!!o?.correct;if(this._reportFilter==="errors"&&r)return;const i=document.createElement("div");i.className=`qcard ${r?"ok":"err"}`,i.innerHTML=`
        <div class="qhdr">
          <div class="qtitle">
            <div class="stat" style="margin-bottom:6px">Вопрос ${t+1}</div>
            <div class="qt">${e.title}</div>
          </div>
          <div class="qstatus">${r?"верно":"ошибка"}</div>
        </div>

        ${e.code?`
          <div class="code qcode">${e.code.replace(/[&<>]/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[e]))}</div>
        `:""}
      `;const s=document.createElement("div");s.className="qa";const d=document.createElement("div");d.className="stat",d.textContent="Ваш ответ:",s.appendChild(d);const c=document.createElement("div");c.className=`you ${r?"ok":"err"}`,o&&o.pick!=null?c.textContent=`${String.fromCharCode(65+o.pick)}) ${a.options[o.pick]}`:c.textContent="—",s.appendChild(c);const l=document.createElement("div");l.className="stat",l.style.marginTop="8px",l.textContent="Правильный:",s.appendChild(l);const u=document.createElement("div");if(u.className="correct-ans",u.textContent=`${String.fromCharCode(65+a.correctIndex)}) ${a.options[a.correctIndex]}`,s.appendChild(u),e.explanation){const t=document.createElement("div");t.className="hint",t.textContent=e.explanation,s.appendChild(t)}if(i.appendChild(s),e.code){const t=document.createElement("button");t.className="btn btn-ghost",t.style.marginTop="6px",t.textContent="Скопировать код",t.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(e.code),t.textContent="Скопировано",setTimeout(()=>t.textContent="Скопировать код",1200)}catch{t.textContent="Не удалось",setTimeout(()=>t.textContent="Скопировать код",1200)}}),i.appendChild(t)}n.appendChild(i)}),!n.children.length){const e=document.createElement("div");e.className="stat",e.style.marginTop="8px",e.textContent="Нет вопросов под выбранный фильтр.",n.appendChild(e)}};r();return}e.innerHTML=`<div class="stat">Квизы не найдены.</div>`}}customElements.define("quiz-widget",QuizWidgetEl);export async function mountQuizWidget(e,{srcs:t=[],opts:n={},firebaseConfig:s={},name:o="Quiz"}={}){function a(e){if(Array.isArray(e))return e;if(typeof e=="string"){const t=e.trim();if(t.startsWith("[")&&t.endsWith("]"))try{return JSON.parse(t)}catch{}return t.split(/[|,]/).map(e=>e.trim()).filter(Boolean)}return[]}const r=a(t);e.innerHTML="";const i=document.createElement("quiz-widget");i.dataset.name=o,e.appendChild(i),await i.init({srcArr:r,firebaseConfig:s,opts:n})}